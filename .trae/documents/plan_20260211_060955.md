# Kế hoạch cải tiến hệ thống quản lý chủ nhà (Host Management)

Dựa trên yêu cầu của bạn, tôi đề xuất kế hoạch triển khai chi tiết như sau để giải quyết vấn đề trùng lặp dữ liệu và tối ưu hóa trải nghiệm người dùng.

## 1. Backend Implementation (Laravel)

### 1.1. API Kiểm tra thông tin Chủ nhà

Tạo endpoint mới để frontend có thể tra cứu thông tin chủ nhà theo số điện thoại.

* **Route:** `GET /webapp/check-host-phone`

* **Controller:** `TelegramWebAppController@checkHostPhone`

* **Logic:**

  * Nhận `phone` từ request.

  * Chuẩn hóa số điện thoại (bỏ số 0 đầu, thêm 84 hoặc ngược lại để khớp với format trong DB).

  * Tìm kiếm trong bảng `crm_hosts` (cột `contact`).

  * Trả về danh sách kết quả JSON: `[{ id, name, gender, contact }]`.

### 1.2. Cập nhật Logic Lưu tin đăng (`submitForm`)

Sửa đổi hàm `submitForm` trong `TelegramWebAppController` để ngăn chặn việc tạo trùng lặp.

* **Hiện tại:** Luôn `new CrmHost()`.

* **Cải tiến:**

  * Sử dụng `CrmHost::firstOrNew(['contact' => $phone])`.

  * Nếu tìm thấy: Cập nhật thông tin mới nhất (Tên, Giới tính) từ form vào bản ghi cũ.

  * Nếu chưa có: Tạo mới.

  * Gán `host_id` cho Property.

## 2. Frontend Implementation (Alpine.js & Blade)

### 2.1. Tái cấu trúc UI form "Thông tin liên hệ"

Sửa file `frontend_dashboard_add_listing.blade.php`:

* **Đảo vị trí:** Đưa trường **Số điện thoại** lên đầu tiên (trước trường Tên).

* **Trạng thái Loading:** Thêm icon loading xoay khi đang gọi API kiểm tra số điện thoại.

### 2.2. Logic Gợi ý (Auto-suggest)

* **Event:** Lắng nghe sự kiện `input` trên trường số điện thoại (debounce 500ms).

* **Action:**

  * Gọi API `/webapp/check-host-phone`.

  * Nếu có kết quả: Hiển thị dropdown bên dưới ô nhập.

  * Nếu người dùng chọn từ dropdown: Tự động điền `name` và `gender`, khóa hoặc highlight để báo hiệu đã khớp dữ liệu cũ.

  * Nếu không có kết quả: Cho phép nhập Tên/Giới tính bình thường.

### 2.3. Validation

* Cập nhật Regex validate số điện thoại VN: `/^(0|\+84)(3|5|7|8|9)[0-9]{8}$/`.

## 3. Testing Strategy

* **Unit Test:** Test endpoint `/webapp/check-host-phone` với các trường hợp: số có trong DB, số mới, số sai định dạng.

* **Integration Test:** Test luồng `submitForm` đảm bảo khi dùng số điện thoại cũ thì `CrmHost::count()` không tăng.

* **Manual Test:** Kiểm tra giao diện, UX dropdown, loading indicator trên trình duyệt.

## 4. Các bước thực hiện

1. **Backend:** Viết hàm `checkHostPhone` và đăng ký route.
2. **Backend:** Refactor `submitForm` để handle `firstOrNew`.
3. **Frontend:** Sửa file Blade, đảo vị trí input, thêm logic Alpine.js gọi API.
4. **Verify:** Chạy thử nghiệm và kiểm tra database.



