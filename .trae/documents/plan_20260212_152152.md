The user is experiencing a "Lỗi kết nối máy chủ" (Server Connection Error) when clicking the "Delete" or "Hide/Show" buttons. This is likely due to the AJAX request failing (500, 404, or 419 error) or returning a non-JSON response that causes the JS `.json()` parsing to fail.

I have analyzed the code and found the following points to address:

1.  **CSRF Token**: The JS `fetch` calls in `dashboard_listings.blade.php` include the `X-CSRF-TOKEN` header: `'X-CSRF-TOKEN': '{{ csrf_token() }}'`. This looks correct.
2.  **Routes**: The routes are defined in `routes/web.php` inside the `telegram.webapp` middleware group:
    ```php
    Route::delete('/webapp/listings/{id}', [TelegramWebAppController::class, 'destroy'])->name('webapp.listings.destroy');
    Route::patch('/webapp/listings/{id}/toggle', [TelegramWebAppController::class, 'toggleStatus'])->name('webapp.listings.toggle');
    ```
3.  **Controller**: The methods `destroy` and `toggleStatus` in `TelegramWebAppController.php` exist and return JSON.
4.  **Potential Issues**:
    *   **Authentication**: The controller uses `Auth::guard('webapp')->user()`. If the user session has expired or the guard is not correctly set for the request, it returns 401.
    *   **Middleware**: The routes are protected by `telegram.webapp` middleware. If this middleware fails or redirects (e.g., if session expired), the fetch call might receive a redirect (302) or HTML login page instead of JSON, causing the `.json()` parsing error in JS, which leads to the `.catch()` block showing "Lỗi kết nối máy chủ".
    *   **URL Construction**: The JS uses `{{ url('/webapp/listings') }}/${id}`. If the app is served from a subdirectory or has a different base URL, this might be incorrect, but `url()` helper usually handles it.
    *   **JS Error Handling**: The current `.catch()` block is generic. It doesn't differentiate between network errors and non-200 responses.

**Plan to Fix & Improve Error Handling:**

1.  **Improve JS Error Handling**:
    *   Modify `fetch` calls to check `response.ok` before parsing JSON.
    *   If `!response.ok`, throw an error with the status text or parse the error body.
    *   Log the actual error to console for debugging.
    *   Provide more specific error messages to the user (e.g., "Phiên đăng nhập hết hạn", "Lỗi không xác định").

2.  **Verify Controller Logic**:
    *   Add validation to ensure `$id` is valid.
    *   Ensure the `try-catch` block in controller returns a proper JSON response with 500 status on error, which we are already doing, but let's double check imports (e.g., `Log` facade).

3.  **Frontend Logic Update**:
    *   Update `deleteListing` and `toggleListing` functions to handle non-JSON responses gracefully (e.g. if the server returns an HTML error page).

4.  **Unit/Integration Tests**:
    *   Create a test case to verify these endpoints return 401 if not logged in, 404 if not found, and 200/JSON on success.

**Actionable Steps:**

1.  Update `resources/views/frontends/components/dashboard_listings.blade.php` with robust error handling in `deleteListing` and `toggleListing`.
2.  Review `TelegramWebAppController.php` to ensure `Log` is imported and used correctly (it is).
3.  Add a test file `tests/Feature/WebappListingTest.php` to verify the endpoints.

I will start by improving the JavaScript error handling to give better feedback and handle the likely case of a non-JSON response (like a 419 Page Expired or 500 HTML error).
